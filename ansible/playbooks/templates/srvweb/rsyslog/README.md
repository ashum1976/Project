
# ПРОЕКТ


![Схема проекта](Images/schem_project.png)



Проект  создаётся на базе 5 виртуальных машин
1. **Firewall** - шлюз для входящих соединений,  на базе iptables

  Внешний шлюз Firewall перенаправляет входящие соединения с адресов внешней сети 192.168.6.0/28:

-  192.168.6.3:443 ---> 192.168.3.5:443 (Srvweb)
-  192.168.6.3:80 ----> 192.168.3.6:80 (Srvbam)   

2. **Srvmysql** и **Backupmysql** - две виртуальные машины используются для развёртывания баз данных используемых в проекте. База для wordpress и база для zabbix. Так же организована репликация между этими серверами (**Srvmysql** и **Backupmysql**).
3. **Srvweb** - виртуальная машина, на которой поднят web проект на базе wordpress
4. **Srvbam** -  виртуальная машина, на которой организован сервис мониторинга за состоянием вирт. машин, на базе zabbix. Система резервного копирования, на базе borg. A так же система сбора логов, с использованием rsyslog

**На всех серверах работает SElinux в режиме enforces**

##### Настройка параметров ядра для увеличения производительности серверов

- минимальное количество свободной памяти:

      $ cat /proc/sys/vm/min_free_kbytes
      67584
Настройка выполняется следующим образом:

      echo <NUMBER> > /proc/sys/vm/min_free_kbytes

При установке этого параметра следует проявлять осторожность: слишком маленькое или слишком большое значение может отрицательно сказаться на производительности системы. Слишком низкое значение min_free_kbytes не позволит системе освободить память. Что может привести к зависанию системы или уничтожению процессов через OOM.
RedHat рекомендует поддерживать min_free_kbytes на уровне 1-3% от объема памяти в системе

- Исрользование свопа

      echo 0 > /proc/sys/vm/swappiness

Также рекомендуется на серверах, с большим объмом памяти,  либо уменьшать параметр swappiness до нуля, либо не использовать своп. В любом случае для операций с низкой задержкой использование свопа резко снизит производительность.



## Вопросы и проблемы при развёртывании проекта посредством ansible.

##### Используемые в ролях проекта специфические команды:

##### BorgBackup
Генерация пароля пользователя для использования в роли borg  
- **openssl passwd -6 qwerty** - генерация хэша пароля qwerty. Параметр -6 говорит о генерации sha512 алгоритме.
##### Firewall
##### Nginx
##### MySQL
##### Rsyslog
##### Wdprs

При появлении такой ошибки:

Uncaught Error: Call to undefined function json_encode() in phar
настройка WordPress через  **_wp-cli_**, ошибка возникает при вызове wp-cli. Необходимо кстановить пакет **_php-json_**

___

##### Zabbix
- Создавать базу **обязательно** с параметрами :
      **character set utf8**
      **collate utf8_bin**
- При восстановлении схемы бызы данных zabix, файл sql (/usr/share/doc/zabbix-sql-scripts/mysql/create.sql.gz ) нужно разархивировать, иначе странная  печальная ошибка:
      **msg: "'b''"**
      Предварительно скачал файл в проект и подготовил для использования.
 ___
